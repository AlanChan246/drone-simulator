<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Simulator - Modular</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🚁</text></svg>">
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/blockly@9.3.3/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly@9.3.3/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly@9.3.3/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly@9.3.3/msg/en.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 主菜单画面 -->
    <div id="main-menu" class="menu-screen">
        <div class="menu-content">
            <div class="menu-left">
                <div class="menu-logo">
                    <h1 class="logo-title">SKYGUARD</h1>
                    <p class="logo-tagline">Code to rescue</p>
                </div>
                <div class="menu-buttons">
                    <button class="menu-btn" onclick="showMissionSelect()">COMPETITION</button>
                    <button class="menu-btn" onclick="startFreePlay()">FREE PLAY</button>
                    <button class="menu-btn" onclick="showBasecamp()">BASECAMP</button>
                    <button class="menu-btn" onclick="showYourMissions()">YOUR MISSIONS</button>
                    <button class="menu-btn" onclick="showLoadScene()">LOAD SCENE</button>
                    <button class="menu-btn" onclick="quitGame()">QUIT</button>
                </div>
            </div>
            <div class="menu-right">
                <div class="menu-preview" id="main-menu-preview">
                    <!-- 3D 預覽將在這裡渲染 -->
                </div>
                <div class="feature-cards">
                    <div class="feature-card">
                        <div class="feature-icon">🧩</div>
                        <h3>Blockly 編程</h3>
                        <p>使用視覺化積木進行編程</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🎮</div>
                        <h3>3D 模擬</h3>
                        <p>即時 3D 無人機飛行模擬</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">🎯</div>
                        <h3>任務挑戰</h3>
                        <p>完成各種任務挑戰</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 任務選擇畫面 -->
    <div id="mission-select-menu" class="menu-screen" style="display: none;">
        <button class="back-btn" onclick="showMainMenu()">←</button>
        <div class="mission-select-content">
            <div class="mission-select-header">
                <h1>COMPETITION MISSIONS</h1>
            </div>
            <div class="mission-select-body">
                <div class="mission-list">
                    <button class="mission-btn" onclick="startMission(1)">MISSION 1</button>
                    <button class="mission-btn" onclick="startMission(2)">MISSION 2</button>
                </div>
                <div class="mission-preview" id="mission-preview">
                    <!-- 3D 場景預覽將在這裡渲染 -->
                </div>
            </div>
            <div class="mission-select-footer">
                <div class="footer-logo">
                    <h2>SKYGUARD</h2>
                    <p>CODE TO RESCUE</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 遊戲界面（預設隱藏） -->
    <div id="game-interface" style="display: none;">
        <div class="top-bar">
            <button class="back-btn-game" onclick="returnToMissionSelect()" title="返回任務選擇">← 返回</button>
            <button class="control-btn toggle-blockly-btn" onclick="toggleBlocklyPanel()" title="顯示/隱藏積木區" id="toggle-blockly-btn">📦 顯示積木區</button>
            <button class="control-btn" onclick="loadMazeAnswer()" id="maze-answer-btn" style="display:none; background-color: #ff9800; color: white;">💡 參考答案</button>
            <select class="scene-select" id="scene-select" onchange="changeScene(this.value)">
                <option value="free">場景: 自由飛行</option>
                <option value="tunnel">任務一: 隧道迷宮</option>
                <option value="city">任務二: 山火應對</option>
            </select>
        </div>
        
        <!-- 右上角设置菜单 -->
        <div class="settings-menu" id="settings-menu">
            <button class="settings-toggle-btn" onclick="toggleSettingsMenu()" title="設置">⚙️</button>
            <div class="settings-panel" id="settings-panel" style="display: none;">
                <div class="settings-item">
                    <label for="speed-slider">速度:</label>
                    <input type="range" id="speed-slider" min="0.1" max="3" step="0.1" value="1">
                    <span id="speed-display">1.0x</span>
                </div>
                <div class="settings-item">
                    <button class="settings-btn" onclick="toggleCameraMode()" id="camera-mode-btn">🎥 視角: 跟隨中</button>
                </div>
            </div>
        </div>
        
        <!-- 右下角浮动控制面板 -->
        <div class="floating-control-panel">
            <div class="execution-progress" id="execution-progress" style="display: none;">
                <span>執行中: <span id="progress-text">0/0</span></span>
            </div>
            <div class="control-buttons-group">
                <button class="floating-btn btn-run" onclick="runBlocklyCode()" title="執行">▶</button>
                <button class="floating-btn btn-stop" onclick="emergencyStop()" title="停止">⬛</button>
                <button class="floating-btn btn-reset" onclick="resetSimulator()" title="重置">⟳</button>
            </div>
        </div>
        <div class="main-container">
            <div id="blocklyDiv" class="blockly-panel">
                <div class="blockly-resizer" id="blockly-resizer"></div>
                <div class="blockly-zoom-controls">
                    <button class="zoom-btn" onclick="zoomBlockly('in')" title="放大">+</button>
                    <button class="zoom-btn" onclick="zoomBlockly('out')" title="縮小">−</button>
                    <button class="zoom-btn" onclick="zoomBlockly('reset')" title="重置">⌂</button>
                </div>
            </div>
            <div id="canvas-container" class="canvas-panel">
                <div class="hud" id="hud-display">Status: LANDED<br>Alt: 0 cm</div>
                
                <div id="console-panel">
                    <div class="console-header">
                        <span>>_ Console Output</span>
                        <button onclick="clearConsole()" style="background:none;border:none;color:#aaa;cursor:pointer;">🗑️ Clear</button>
                    </div>
                    <div id="console-content"></div>
                </div>
            </div>
        </div>
    </div>
    <xml id="toolbox" style="display: none">
        <category name="Events" colour="#FFBF00">
            <block type="event_start"></block>
            <block type="event_wait_key"></block>
        </category>
        <category name="Flight Commands" colour="#4C97FF">
            <label text="Basic"></label>
            <block type="drone_takeoff"></block>
            <block type="drone_land"></block>
            <block type="drone_hover">
                <value name="DURATION"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
            </block>
            <block type="drone_collect_water"></block>
            <block type="drone_release_water"></block>
            <block type="drone_move_time">
                <value name="DURATION"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
                <value name="POWER"><shadow type="math_number"><field name="NUM">50</field></shadow></value>
            </block>
            <block type="drone_move_cm">
                <value name="DIST"><shadow type="math_number"><field name="NUM">50</field></shadow></value>
            </block>
            <block type="drone_goto_xyz">
                <value name="X"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                <value name="Y"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                <value name="Z"><shadow type="math_number"><field name="NUM">0.8</field></shadow></value>
            </block>
            <block type="drone_turn_degree">
                <value name="DEGREE"><shadow type="math_number"><field name="NUM">90</field></shadow></value>
            </block>
            <block type="drone_turn_time">
                <value name="DURATION"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
                <value name="POWER"><shadow type="math_number"><field name="NUM">50</field></shadow></value>
            </block>
            <label text="Advanced"></label>
            <block type="drone_set_variable">
                <value name="VAL"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
            </block>
            <block type="drone_turn_heading">
                <value name="DEGREE"><shadow type="math_number"><field name="NUM">90</field></shadow></value>
            </block>
            <block type="drone_move_complex">
                <value name="DURATION"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
            </block>
            <block type="drone_move_complex_infinite"></block>
        </category>
        <category name="Lights" colour="260">
            <block type="drone_set_led_color">
                <value name="COLOR"><shadow type="colour_picker"><field name="COLOUR">#ff0000</field></shadow></value>
                <value name="BRIGHTNESS"><shadow type="math_number"><field name="NUM">255</field></shadow></value>
            </block>
            <block type="drone_set_led_rgb">
                <value name="R_VAL"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                <value name="G_VAL"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                <value name="B_VAL"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                <value name="BRIGHTNESS"><shadow type="math_number"><field name="NUM">255</field></shadow></value>
            </block>
            <block type="drone_led_off"></block>
            <label text="Light Sequences"></label>
            <block type="drone_led_sequence">
                <value name="R_VAL"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                <value name="G_VAL"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                <value name="B_VAL"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
            </block>
        </category>
        <category name="Sensors" colour="#5b67a5">
            <block type="drone_get_range">
                <field name="TYPE">front</field><field name="UNIT">cm</field>
            </block>
            <block type="drone_get_height"><field name="UNIT">cm</field></block>
        </category>
        <category name="Console" colour="#5ba5e0">
            <block type="drone_print">
                <value name="TEXT"><shadow type="text"><field name="TEXT">Hello</field></shadow></value>
            </block>
            <block type="text"></block>
            <block type="text_join"></block>
        </category>
        <sep></sep>
        <category name="Logic" colour="#5C81A6">
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
            <block type="logic_ternary"></block>
        </category>
        <category name="Control" colour="#FFAB19">
            <block type="controls_if"></block>
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number"><field name="NUM">4</field></shadow>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
            <block type="controls_flow_statements"></block>
        </category>
        <category name="Math" colour="#59C059">
            <block type="math_number"><field name="NUM">0</field></block>
            <block type="math_arithmetic"></block>
            <block type="math_random_int">
                <value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
                <value name="TO"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
            </block>
            <block type="math_round"></block>
            <block type="math_modulo"></block>
        </category>
        <category name="Variables" colour="#a5c73d" custom="VARIABLE"></category>
        <category name="Lists" colour="#745ba5" custom="LIST"></category>
        <category name="Functions" colour="#d65cd6" custom="PROCEDURE"></category>
    </xml>
    <!-- 任務結算彈窗 -->
    <div id="result-modal" class="modal-overlay" style="display: none;">
        <div class="result-card">
            <div class="result-header">
                <h2>任務完成！ MISSION COMPLETE</h2>
                <div class="result-icon">🏆</div>
            </div>
            <div class="result-body">
                <table class="result-table">
                    <tr>
                        <td>信號標記點 (Beacons)</td>
                        <td id="res-beacons">0 / 3</td>
                        <td id="res-beacons-score">+0</td>
                    </tr>
                    <tr>
                        <td>成功抵達出口</td>
                        <td>YES</td>
                        <td id="res-exit-score">+200</td>
                    </tr>
                    <tr>
                        <td>任務耗時 (Time)</td>
                        <td id="res-time">0s</td>
                        <td id="res-time-bonus">+0</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="2">總得分 (TOTAL SCORE)</td>
                        <td id="res-total">0</td>
                    </tr>
                </table>
            </div>
            <div class="result-footer">
                <button class="result-btn btn-challenge" id="challenge-btn" onclick="closeResultModal(); startChallengeMode();" style="background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); color: white;">🔥 挑戰隨機迷宮</button>
                <button class="result-btn btn-retry" onclick="closeResultModal(); resetSimulator();">重試一次</button>
                <button class="result-btn btn-continue" onclick="closeResultModal(); returnToMissionSelect();">返回選單</button>
            </div>
        </div>
    </div>

    <script src="js/simulator.js"></script>
    <script src="js/blockly_def.js"></script>
    <script src="js/main.js"></script>
</body>
</html>